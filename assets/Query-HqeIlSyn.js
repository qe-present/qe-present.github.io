import{M as be,D as Ve,B as Be,N as U,G as ae}from"./GetMap-Jqi3_2AR.js";import{c as Fe,g as xe,r as h,p as Qe,U as Me,V as Ne,R as Y,h as Ie,b as qe,W as Ae,X as re,Y as Oe,Z as Ue,$ as Ge,a0 as _e,_ as z,L as oe,D as T,s as S,t as Se,u as R,J as V,v as f,P as Ee,a1 as Te,G as P,z as E,x as $,a2 as je,a3 as Je,a as K,Q as G,a4 as ne,N as ze,I as He,H as Ze,a5 as Ke,F as W,a6 as se}from"./index-CKYMjInt.js";import{Q as le}from"./QSelect-uLTFd24Y.js";import{u as ue}from"./use-quasar-CgCWa3Dl.js";import{Q as We,p as ie,s as ce,h as de,m as me}from"./query-CgCRGN2d.js";import{api as Xe}from"./axios-DIXsm6-z.js";import"./setting-store-DakWXgMI.js";import"./QItem-DhUPfHRo.js";import"./QItemLabel-uSN5iPk0.js";import"./position-engine-DMM3dGCF.js";import"./selection-dqQqdJ2o.js";import"./axios-B4uVmeYG.js";const Ye=Fe({name:"QForm",props:{autofocus:Boolean,noErrorFocus:Boolean,noResetFocus:Boolean,greedy:Boolean,onSubmit:Function},emits:["reset","validationSuccess","validationError"],setup(a,{slots:r,emit:n}){const e=xe(),l=h(null);let u=0;const t=[];function i(s){const d=typeof s=="boolean"?s:a.noErrorFocus!==!0,b=++u,x=(m,g)=>{n(`validation${m===!0?"Success":"Error"}`,g)},Q=m=>{const g=m.validate();return typeof g.then=="function"?g.then(y=>({valid:y,comp:m}),y=>({valid:!1,comp:m,err:y})):Promise.resolve({valid:g,comp:m})};return(a.greedy===!0?Promise.all(t.map(Q)).then(m=>m.filter(g=>g.valid!==!0)):t.reduce((m,g)=>m.then(()=>Q(g).then(y=>{if(y.valid===!1)return Promise.reject(y)})),Promise.resolve()).catch(m=>[m])).then(m=>{if(m===void 0||m.length===0)return b===u&&x(!0),!0;if(b===u){const{comp:g,err:y}=m[0];if(y!==void 0&&console.error(y),x(!1,g),d===!0){const N=m.find(({comp:I})=>typeof I.focus=="function"&&Ae(I.$)===!1);N!==void 0&&N.comp.focus()}}return!1})}function p(){u++,t.forEach(s=>{typeof s.resetValidation=="function"&&s.resetValidation()})}function c(s){s!==void 0&&re(s);const d=u+1;i().then(b=>{d===u&&b===!0&&(a.onSubmit!==void 0?n("submit",s):s!==void 0&&s.target!==void 0&&typeof s.target.submit=="function"&&s.target.submit())})}function w(s){s!==void 0&&re(s),n("reset"),Oe(()=>{p(),a.autofocus===!0&&a.noResetFocus!==!0&&_()})}function _(){Ue(()=>{if(l.value===null)return;const s=l.value.querySelector("[autofocus][tabindex], [data-autofocus][tabindex]")||l.value.querySelector("[autofocus] [tabindex], [data-autofocus] [tabindex]")||l.value.querySelector("[autofocus], [data-autofocus]")||Array.prototype.find.call(l.value.querySelectorAll("[tabindex]"),d=>d.tabIndex!==-1);s?.focus({preventScroll:!0})})}Qe(Ge,{bindComponent(s){t.push(s)},unbindComponent(s){const d=t.indexOf(s);d!==-1&&t.splice(d,1)}});let v=!1;return Me(()=>{v=!0}),Ne(()=>{v===!0&&a.autofocus===!0&&_()}),Y(()=>{a.autofocus===!0&&_()}),Object.assign(e.proxy,{validate:i,resetValidation:p,submit:c,reset:w,focus:_,getValidationComponents:()=>t}),()=>Ie("form",{class:"q-form",ref:l,onSubmit:c,onReset:w},qe(r.default))}}),C=_e("data",{state:()=>({data:{},bounds:[],polygon:[],type:"",map:null,radius:0,circleLayer:null}),getters:{getCircleLayer(){return this.circleLayer},getRadius(){return this.radius},getData(){return this.data},getMap(){return this.map}},setters:{setCircleLayer(a){this.circleLayer=a},setRadius(a){this.radius=a},setData(a){this.data=a},setMap(a){this.map=a}},mutations:{},actions:{isAvailable(a){switch(this.type){case"Rectangle":case"Polygon":return a==="多边形";case"全部":return!0;case"Marker":return a==="圆";default:return!1}}}}),F=_e("result",{state:()=>({resultLayer:null,selectedId:null}),getters:{getResultLayer(){return this.resultLayer}},actions:{addResultLayer(a){this.resultLayer.push(a)},popResultLayer(){return this.resultLayer.pop()},getLength(){return this.resultLayer.getLayers().length},setSelectedId(a){this.selectedId=a}}});let j,J,B;const pe=async(a,r,n)=>(j=new L.supermap.QueryByBoundsParameters({queryParams:{name:`${r}@Changchun`,attributeFilter:n},bounds:a}),console.log({name:`${r}@Changchun`}),J=await new L.supermap.QueryService(be).queryByBounds(j),J.result.recordsets[0].features.features),X=async(a,r,n)=>(j=new L.supermap.QueryByGeometryParameters({queryParams:{name:`${r}@Changchun`,attributeFilter:n},geometry:a}),J=await new L.supermap.QueryService(be).queryByGeometry(j),B=J.result.recordsets[0].features.features,B.length>0?B:[]),ge=async(a,r)=>{let n=new L.supermap.GetFeaturesBySQLParameters({queryParameter:{name:`${r}@Changchun`,attributeFilter:a},datasetNames:[`Changchun:${r}`],fromIndex:0,toIndex:1e9}),e=await new L.supermap.FeatureService(Ve).getFeaturesBySQL(n);return B=L.geoJSON(e.result.features).toGeoJSON(),B.features.length>0?B.features:[]},$e={__name:"Result",props:{dialog:{},dialogModifiers:{},tableData:{},tableDataModifiers:{}},emits:["update:dialog","update:tableData"],setup(a,{expose:r}){r();const n=F(),e=C(),l=h("bottom"),u=oe(a,"dialog"),t=oe(a,"tableData"),i=h([]),p=[{name:"content",label:"地名",field:"content"}];let c=t.value;T(()=>{c=t.value});const _={resultStore:n,dataStore:e,bottom:l,dialog:u,tableData:t,selected:i,columns:p,get rows(){return c},set rows(v){c=v},handleSelectionChange:v=>{let s=v.rows[0],b=n.getResultLayer.getLayer(s.id);b&&e.map.flyTo(b.getLatLng(),11)},ref:h,watchEffect:T,toRaw:Te,get useDataStore(){return C},get useResultStore(){return F}};return Object.defineProperty(_,"__isScriptSetup",{enumerable:!1,value:!0}),_}},et={class:"q-pa-md"};function tt(a,r,n,e,l,u){return S(),Se(Ee,{modelValue:e.dialog,"onUpdate:modelValue":r[1]||(r[1]=t=>e.dialog=t),position:e.bottom},{default:R(()=>[V("div",et,[f(We,{title:"查询结果",rows:e.rows,columns:e.columns,"row-key":"content",selection:"single",selected:e.selected,"onUpdate:selected":r[0]||(r[0]=t=>e.selected=t),onSelection:e.handleSelectionChange},null,8,["rows","selected"])])]),_:1},8,["modelValue","position"])}const at=z($e,[["render",tt],["__file","Result.vue"]]),rt={__name:"MarkerPopup",props:{contents:{type:Object,required:!0}},setup(a,{expose:r}){r();const n=a;let e=n.contents,l,u,t,i;T(()=>{t=n.contents,l=t.content,u=t.name,console.log(l,u)});const p={props:n,get markers(){return e},set markers(c){e=c},get content(){return l},set content(c){l=c},get name(){return u},set name(c){u=c},get contentsValue(){return t},set contentsValue(c){t=c},get imageUrl(){return i},set imageUrl(c){i=c},watchEffect:T};return Object.defineProperty(p,"__isScriptSetup",{enumerable:!1,value:!0}),p}},ot=a=>(je("data-v-744b9190"),a=a(),Je(),a),nt={id:"pop"},st={key:0,id:"pop"},lt={key:1,id:"pop"},ut=ot(()=>V("img",{src:"https://picsum.photos/200/300",width:"60",height:"60"},null,-1));function it(a,r,n,e,l,u){return S(),P("div",null,[V("h5",nt,E(e.markers.content),1),e.name.address?(S(),P("div",st,E("地址:"+e.name.address),1)):$("",!0),e.name.telephone?(S(),P("div",lt,E("电话:"+e.name.telephone),1)):$("",!0),ut])}const fe=z(rt,[["render",it],["__scopeId","data-v-744b9190"],["__file","MarkerPopup.vue"]]),ct="/place/v2/search",dt="Nm6OVrNh6nj36njTpVnxnrHsGLZS9qGI",ye=async a=>{let r={query:a,region:"长春市",output:"json",ak:dt};return(await Xe.get(ct,{params:r,headers:{"Access-Control-Allow-Origin":"*"}})).data.results[0]},he={drawMarker:!1,drawPolyline:!1,drawRectangle:!0,drawPolygon:!0,drawCircle:!1,drawCircleMarker:!1,editMode:!1,cutPolygon:!1,dragMode:!1,deleteLayer:!1},ve={drawMarker:!0,drawRectangle:!1,drawPolyline:!1,drawPolygon:!1,drawCircle:!1,drawCircleMarker:!1,editMode:!1,cutPolygon:!1,dragMode:!1,deleteLayer:!1},mt=C(),Le=async a=>{let r=new L.supermap.SpatialAnalystService(Be),n=new L.supermap.GeometryBufferAnalystParameters({sourceGeometry:mt.polygon,bufferSetting:new L.supermap.BufferSetting({endType:L.supermap.BufferEndType.ROUND,leftDistance:new L.supermap.BufferDistance({value:a}),rightDistance:new L.supermap.BufferDistance({value:a}),semicircleLineSegment:200})});return(await r.bufferAnalysis(n)).result.resultGeometry},pt={__name:"QueryForm",setup(a,{expose:r}){r();const n=K(()=>{switch(u.value){case"医院":return de;case"学校":return ce;default:return ie}}),e=C(),l=F(),u=h("医院"),t=h(""),i=h("全部"),p=h(null),c=ue(),w=h(!1),_=h(!1);let v=h([]),s,d,b,x,Q,M,m,g=["医院","学校","公园"],y=["全部","多边形","圆"];const N=o=>L.icon({iconUrl:`marker/${o}.png`,iconSize:[20,20]}),I=o=>{switch(o){case"医院":return"Hospital";case"学校":return"School";case"公园":return"Park";default:return!1}},q=o=>{if(v.value=[],l.getLength()>0&&l.resultLayer.clearLayers(),w.value=!0,o.length===0){c.notify({type:"negative",message:"未找到相关结果"});return}let H=l.getResultLayer;o.forEach(function(k){let A=k.geometry.coordinates[1],Z=k.geometry.coordinates[0],O=k.properties.name||k.properties.NAME,D=L.marker([A,Z],{icon:M}).addTo(H);D.on("click",async function(kt){let Ce=await ye(O);const De=se(fe,{contents:{content:O,name:Ce}}),te=document.createElement("div");De.mount(te),this.bindPopup(te),this.openPopup()}),v.value.push({id:D._leaflet_id,lat:D._latlng.lat,lng:D._latlng.lng,content:O})})},we=async()=>{let o="",H=u.value,k=t.value,A=i.value,Z=p.value;if(A===U?(e.type=U,k.trim()===""?o="":o="name like'%"+k.trim()+"%'"):o="name like'%"+k.trim()+"%'",!e.isAvailable(A)){c.notify({type:"negative",message:"未选择有效范围或范围不合法"});return}switch(s=I(H),M=N(s),e.type){case"Rectangle":d=await pe(e.bounds,s,o),q(d);break;case"Polygon":d=await X(e.polygon,s,o),q(d);break;case U:d=await ge(o,s),q(d);break;case"Marker":e.circleLayer&&e.map.removeLayer(e.circleLayer),e.map.hasLayer(e.polygon)&&e.map.removeLayer(e.polygon);let D=await Le(Z);e.circleLayer=L.geoJSON(D).addTo(e.map),d=await X(e.circleLayer,s,o),q(d);break}},ke=()=>{u.value="医院",i.value="全部",p.value=null,t.value=null,w.value=!1,l.getLength()>0&&(e.map.removeLayer(l.resultLayer),e.map.removeLayer(e.polygon))},Re=()=>{l.getLength()>0?w.value=!0:c.notify({type:"negative",message:"未查询到结果",position:"bottom-right"})},Pe=K(()=>n.value.filter(o=>me(o,t.value)&&o.toLowerCase()!==t.value.toLowerCase())),ee={allSuggestions:n,dataStore:e,resultStore:l,type:u,key:t,rangeType:i,radius:p,$q:c,showResult:w,isFocus:_,get tableData(){return v},set tableData(o){v=o},get place(){return s},set place(o){s=o},get res(){return d},set res(o){d=o},get resultLayer(){return b},set resultLayer(o){b=o},get oldLayer(){return x},set oldLayer(o){x=o},get resultLayerList(){return Q},set resultLayerList(o){Q=o},get icon(){return M},set icon(o){M=o},get map(){return m},set map(o){m=o},get options(){return g},set options(o){g=o},get rangeOptions(){return y},set rangeOptions(o){y=o},getIcon:N,getEnglishName:I,handleResponse:q,onSubmit:we,onReset:ke,handleQueryResult:Re,filteredSuggestions:Pe,selectSuggestion:o=>{t.value=o},handleChange:o=>{o==="全部"&&e.map.pm.removeControls(),o==="多边形"&&e.map.pm.addControls(he),o==="圆"&&(c.notify({type:"info",message:"请在地图上点击圆心,并输入半径",position:"top-left",timeout:1e3}),e.map.pm.addControls(ve))},computed:K,createApp:se,ref:h,get useDataStore(){return C},get useResultStore(){return F},get useQuasar(){return ue},get getBoundsData(){return pe},get getNoRangeData(){return ge},get getPolygonData(){return X},Result:at,MarkerPopup:fe,get GetInfo(){return ye},get match(){return me},get hospitalName(){return de},get prakName(){return ie},get schoolName(){return ce},get NoRange(){return U},get control(){return he},get controlMarker(){return ve},get getCircle(){return Le}};return Object.defineProperty(ee,"__isScriptSetup",{enumerable:!1,value:!0}),ee}},gt={class:"q-pa-md"},ft={class:"suggestions-list"},yt=["onClick"];function ht(a,r,n,e,l,u){return S(),P("div",gt,[f(Ye,{onSubmit:e.onSubmit,onReset:e.onReset,class:"q-gutter-md"},{default:R(()=>[f(le,{color:"lime-14","bg-color":"blue",filled:"",modelValue:e.type,"onUpdate:modelValue":r[0]||(r[0]=t=>e.type=t),options:e.options,label:"选择服务类型",rules:[t=>t!==null||"请选择服务类型"],"transition-show":"flip-up","transition-hide":"flip-down","emit-value":""},{prepend:R(()=>[f(G,{name:"event"})]),_:1},8,["modelValue","options","rules"]),V("div",null,[f(ne,{filled:"","bg-color":"blue",modelValue:e.key,"onUpdate:modelValue":r[1]||(r[1]=t=>e.key=t),label:"输入查询关键字",onFocus:r[2]||(r[2]=t=>e.isFocus=!0),onBlur:r[3]||(r[3]=t=>e.isFocus=!1)},{prepend:R(()=>[f(G,{name:"event"})]),default:R(()=>[ze(V("ul",ft,[(S(!0),P(He,null,Ze(e.filteredSuggestions,(t,i)=>(S(),P("li",{key:i,onClick:p=>e.selectSuggestion(t),class:"suggestion-item"},E(t),9,yt))),128))],512),[[Ke,e.filteredSuggestions.length>0&&e.isFocus]])]),_:1},8,["modelValue"])]),f(le,{color:"lime-14","bg-color":"blue",filled:"",modelValue:e.rangeType,"onUpdate:modelValue":[r[4]||(r[4]=t=>e.rangeType=t),e.handleChange],options:e.rangeOptions,label:"选择范围类型",rules:[t=>t!==null||"请选择范围类型"],"transition-show":"flip-up","transition-hide":"flip-down"},{prepend:R(()=>[f(G,{name:"event"})]),_:1},8,["modelValue","options","rules"]),e.rangeType==="圆"?(S(),Se(ne,{key:0,color:"lime-11","bg-color":"green",filled:"",modelValue:e.radius,"onUpdate:modelValue":r[5]||(r[5]=t=>e.radius=t),modelModifiers:{number:!0},type:"number",label:"输入圆形的半径",rules:[t=>t>0||"半径必须大于0"]},{prepend:R(()=>[f(G,{name:"event"})]),_:1},8,["modelValue","rules"])):$("",!0),V("div",null,[f(W,{label:"确定",type:"submit",color:"primary"}),f(W,{label:"重置",type:"reset",color:"warning",class:"q-ml-sm"}),f(W,{style:{background:"#FF0080",color:"white",margin:"0 20px"},label:"查询结果",onClick:e.handleQueryResult})])]),_:1}),f(e.Result,{dialog:e.showResult,"onUpdate:dialog":r[6]||(r[6]=t=>e.showResult=t),tableData:e.tableData,"onUpdate:tableData":r[7]||(r[7]=t=>e.tableData=t)},null,8,["dialog","tableData"])])}const vt=z(pt,[["render",ht],["__scopeId","data-v-3e9cda71"],["__file","QueryForm.vue"]]),Lt={__name:"Query",setup(a,{expose:r}){r();const n=C(),e=F();let l=[],u;Y(()=>{u=ae(!1,!1,"zh"),e.resultLayer=L.layerGroup().addTo(u),n.map=u,u.on("pm:create",function(i){let p=i.layer;l.length>0&&(u.removeLayer(l[0]),l.pop()),n.map.hasLayer(n.polygon)&&n.map.removeLayer(n.polygon),n.circleLayer&&n.map.removeLayer(n.circleLayer),l.push(p),n.type=i.shape,n.data=p.toGeoJSON(),n.polygon=p,(i.shape==="Rectangle"||i.shape==="Polygon")&&(n.bounds=p.getBounds())})});const t={dataStore:n,resultStore:e,get oldLayer(){return l},set oldLayer(i){l=i},get map(){return u},set map(i){u=i},get GetMap(){return ae},QueryForm:vt,get useDataStore(){return C},get useResultStore(){return F},onMounted:Y};return Object.defineProperty(t,"__isScriptSetup",{enumerable:!1,value:!0}),t}},bt={id:"map"};function _t(a,r,n,e,l,u){return S(),P("div",bt,[f(e.QueryForm,{id:"query"})])}const At=z(Lt,[["render",_t],["__file","Query.vue"]]);export{At as default};
